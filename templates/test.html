<!DOCTYPE html>

<html lang="en" data-bs-theme="dark">

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, width=device-width">

        <!-- http://getbootstrap.com/docs/5.3/ -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

        <!-- https://favicon.io/favicon-generator/ -->
        <link href="../static/favicon.ico" rel="icon">

        <link href="/static/styles.css" rel="stylesheet">

        <title>Resi.ai: {% block title %}{% endblock %}</title>

    </head>

    <body>

        <nav class="navbar navbar-expand-md bg-dark" data-bs-theme="dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <!-- https://favicon.io/logo-generator/ -->
                    <img src="../static/faviconio-logo/logo-header.png" alt="Resi.ai Logo">
                </a>
                <button aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar" data-bs-toggle="collapse" type="button">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbar">
                    {% if session["user_id"] %}
                        <ul class="navbar-nav me-auto mt-2">
                            <li class="nav-item"><a class="nav-link" href="/account">Account</a></li>
                            <li class="nav-item"><a class="nav-link" href="/api_key">Enter API</a></li>
                            <li class="nav-item"><a class="nav-link" href="/price_estimator">Price Estimator</a></li>
                            <li class="nav-item"><a class="nav-link" href="/">Tailored Resume</a></li>
                            <li class="nav-item"><a class="nav-link" href="/history">History</a></li>
                        </ul>
                        <ul class="navbar-nav ms-auto mt-2">
                            <li class="nav-item"><a class="nav-link" href="/logout">Log Out</a></li>
                        </ul>
                    {% else %}
                        <ul class="navbar-nav ms-auto mt-2">
                            <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                            <li class="nav-item"><a class="nav-link" href="/register">Register</a></li>
                            <li class="nav-item"><a class="nav-link" href="/login">Log In</a></li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </nav>

        {% if get_flashed_messages() %}
            <header>
                <div class="alert alert-primary mb-0 text-center" role="alert">
                    {{ get_flashed_messages() | join(" ") }}
                </div>
            </header>
        {% endif %}

        <main class="container py-3 text-center">
            <div class="container text-area">
                <h1>Setting Up Your OpenAI API Key</h1>
                <p>
                    Setting up your OpenAI API key is simple and only takes a few minutes. Start by going to 
                    OpenAI's <a href="https://openai.com/">website</a> and select login or sign up. From there,
                    you'll want to select the "API" card when prompted. You may need to relogin to get this section 
                    if you just registered for an account.
                </p>
                <figure class="mb-3 mt-3">
                    <img src="../static/openai-api-selection.png" class="rounded api-key-image" alt="API Selection Card">
                    <figcaption>Selection for ChatGPT or API from OpenAI</figcaption>
                </figure>
                <p>
                    After selecting the API section, navigate to the left side bar and select API keys from the menu. It should be
                    the lock symbol.
                </p>
                <figure class="mb-3 mt-3">
                    <img src="../static/openai-api-keys.png" class="rounded api-key-image" alt="API Keys">
                    <figcaption>Side menu to access OpenAI's API keys</figcaption>
                </figure>
                <p>
                    Select the "+ Create new secret key" button, name your new secret key "resi.ai", and click the "Create secret key"
                    button. This will gernerate a secret key that you cannot give to anyone. Copy that secret key and paste it into the
                    API Key input box below. Resi.ai will encrypt your key so that only you can access it.
                </p>
                <figure class="mb-3 mt-3">
                    <img src="../static/openai-api-creation.png" class="rounded api-key-image" alt="API Key Creation">
                    <figcaption>Side menu to access OpenAI's API keys</figcaption>
                </figure>
                <p>
                    If your secret key is compromised, or if you ever want to create another key for any reason, just follow the steps
                    above to create another key. You can add funds to your OpenAI account from this point. Usually, $5 is a good place
                    to start, and you can add more as you need.
                </p>
            </div>
        
            <form action="/api_key" id="apikeyForm" method="post">
                <div class="form-container mt-3">
                    <div class="form-floating mb-3">
                        <input autofill="off" type="password" class="form-control" id="floatingAPI" placeholder="API Key" name="user_api_key" required value={{ user_api_key }}>
                        <label for="floatingAPI">API Key</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Enter API Key</button>
            </form>
            <div id="liveAlertPlaceholder"></div>
        </main>

        <footer class="mb-5">

            <p class="mb-3 small text-center">
                Powered by <a href="https://openai.com/chatgpt">ChatGPT</a>
            </p>

            <form action="https://validator.w3.org/check" class="text-center" enctype="multipart/form-data" method="post" target="_blank">
                <input name="doctype" type="hidden" value="HTML5">
                <input name="fragment" type="hidden">
                <input alt="Validate" src="/static/I_heart_validator.png" type="image"> <!-- https://validator.w3.org/ -->
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Adapted from https://stackoverflow.com/a/10162353
                    const html = '<!DOCTYPE ' +
                    document.doctype.name +
                    (document.doctype.publicId ? ' PUBLIC "' + document.doctype.publicId + '"' : '') +
                    (!document.doctype.publicId && document.doctype.systemId ? ' SYSTEM' : '') +
                    (document.doctype.systemId ? ' "' + document.doctype.systemId + '"' : '') +
                    '>\n' + document.documentElement.outerHTML;
                    document.querySelector('form[action="https://validator.w3.org/check"] > input[name="fragment"]').value = html;
                });

                $(document).ready(function() {
                    const appendAlert = (message, type) => {
                        const wrapper = $(`
                            <div class="alert alert-${type} alert-dismissible" role="alert">
                                <div>${message}</div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `);
                
                        $('#liveAlertPlaceholder').append(wrapper);
                    };
                
                    $('#apikeyForm').submit(function(event) {
                        event.preventDefault(); // Prevent the form from submitting via the browser
                        var form = $(this);
                        var url = form.attr('action');
                
                        $.ajax({
                            type: "POST",
                            url: url,
                            data: form.serialize(), // Serialize form data
                            success: function(response) {
                
                                if(response.status === 'success') {
                                    // Append the alert when the return is successful
                                    appendAlert('API key successfully updated!', 'success')
                                }
                
                                else if(response.status === 'error') {
                                    // Display a meeasge about what went wrong
                                    alert(response.message)
                                }
                            },
                            error: function() {
                                // Handle error
                                alert('An error occurred. Please try again.');
                            },
                        });
                    });
                });
            </script>                
        </footer>
            
    </body>

</html>